networks:
  boreas_net:
    external: true

services:
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.celery
    container_name: boreas_celery_beat
    working_dir: /app
    command: celery -A boreas_mediacion.celery beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media:ro
      - ./boreas_mediacion/management/commands:/app/boreas_mediacion/management/commands
    environment:
      - PYTHONPATH=/app/boreas_mediacion
    env_file: .env
    depends_on:
      - web
      - redis
    networks:
      - boreas_net
  redis:
    image: redis:7-alpine
    container_name: boreas_redis
    ports:
      - "6379:6379"
    networks:
      - boreas_net

  celery:
    build:
      context: .
      dockerfile: Dockerfile.celery
    container_name: boreas_celery
    working_dir: /app
    command: celery -A boreas_mediacion.celery worker --loglevel=info
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media:ro
      - ./boreas_mediacion/management/commands:/app/boreas_mediacion/management/commands
    environment:
      - PYTHONPATH=/app/boreas_mediacion
    env_file: .env
    depends_on:
      - web
      - redis
    networks:
      - boreas_net
  db:
    image: timescale/timescaledb:2.13.1-pg15
    container_name: boreas_db
    environment:
      POSTGRES_DB: boreas_db
      POSTGRES_USER: boreas_user
      POSTGRES_PASSWORD: boreas_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U boreas_user -d boreas_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      boreas_net:
        aliases:
          - db

  web:
    build: .
    container_name: boreas_app
    command: /bin/sh -c "chown -R appuser:appuser /app/staticfiles && gunicorn --bind 0.0.0.0:8000 --workers 4 --chdir /app/boreas_mediacion boreas_mediacion.wsgi:application"
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media:ro
      - ./boreas_mediacion/management/commands:/app/boreas_mediacion/management/commands
    ports:
      - "8000:8000"
    env_file: .env
    networks:
      - boreas_net
  # The app code is mounted from ./boreas_mediacion and runs on port 8100.
  # Adjust the image or build context as needed for your bot implementation.

  nginx:
    image: nginx:alpine
    container_name: boreas_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/media
    depends_on:
      - web
    restart: unless-stopped
    networks:
      - boreas_net

  go_mqtt:
    build:
      context: ./go_mqtt
    container_name: go_mqtt
    environment:
      - MQTT_BROKER=${MQTT_BROKER:-mqtt.solutions-iot.es:8883}
      - TOPIC_API_URL=${TOPIC_API_URL:-http://web:8000/api/active-topics/}
      - PG_CONN=${PG_CONN:-host=db user=boreas_user password=boreas_password dbname=boreas_db sslmode=disable}
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - DEVICE_MAP_PATH=/app/media/external_devices_map.json
    volumes:
      - media_volume:/app/media
    depends_on:
      - db
      - web
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    tmpfs:
      - /tmp:size=100m
    networks:
      - boreas_net

  go_anomaly_detector:
    build:
      context: ./go_anomaly_detector
    container_name: go_anomaly_detector
    environment:
      - PG_CONN=postgres://boreas_user:boreas_password@db:5432/boreas_db?sslmode=disable
      - PARQUET_DIR=/app/data/reported_measures_archive
      - CHECK_INTERVAL=5m
      - BASELINE_DAYS=7
    volumes:
      - ./data:/app/data
    depends_on:
      - db
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    tmpfs:
      - /tmp:size=100m
    networks:
      - boreas_net

volumes:
  postgres_data:
  static_volume:
  media_volume:
